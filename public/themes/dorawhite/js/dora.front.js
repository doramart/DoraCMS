function loginOut(){$.ajax({url:"/users/logout",method:"GET",success:function(e){200===e.status?window.location="/":alert("未知异常，请稍后重试")}})}function getScrollTop(){return document.documentElement.scrollTop||window.pageYOffset||document.body.scrollTop}function initCheckModal(e,s,o){$("#checkIfDo").on("show.bs.modal",function(e){$(this).find(".modal-msg").text(s)}).on("hide.bs.modal",function(e){}),$("#checkIfDo").modal("show"),e.confirmDo=function(){$("#checkIfDo").modal("hide"),o()}}$(function(){$("#userLoginOut").click(function(){loginOut()}),$("#gotop").click(function(){return $("body,html").animate({scrollTop:0},800),!1}),$(window).scroll(function(e){100<getScrollTop()?$("#gotop").css("opacity",1):$("#gotop").css("opacity",0)})}),avalon.filters.cutwords=function(e,s){return e?e.replace(/[\u0391-\uFFE5]/g,"aa").length>s?e.substring(0,s)+"...":e:""},avalon.filters.formatDateByType=function(e,s){var o="";return"mini"==s?o=e.substring(e.length-8,e.length-3):(s="date")&&(o=e.substring(0,9)),o},toastr.options={debug:!1,positionClass:"toast-top-center",timeOut:"2000",showMethod:"fadeIn",hideMethod:"fadeOut"};var searchVm=avalon.define({$id:"headerCtr",searchkey:"",message:"",activeSearch:!1,showErr:!1,postArticel:function(){"true"==$("#logined").val()?window.location.href="/users/userAddContent":window.location.href="/users/login"},searchMe:function(){searchVm.activeSearch=!searchVm.activeSearch},searchOpt:function(e){searchVm.searchkey&&13==e.keyCode&&(window.location.href="/search/"+searchVm.searchkey)}}),postArticelVm=avalon.define({$id:"documentInfo",message:"",showErr:!1}),adminLoginVm=avalon.define({$id:"adminUserlogin",password:"",userName:"",message:"",imageCode:"",showErr:!1,imgCodeUrl:"/api/getImgCode",reSetImgCode:function(){adminLoginVm.imgCodeUrl="/api/getImgCode?"+Math.random()},validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),adminLoginVm.showErr=!0,adminLoginVm.message=e[0].message;else{console.log("全部通过");var s={userName:adminLoginVm.userName,password:CryptoJS.MD5("dora"+adminLoginVm.password).toString(),imageCode:adminLoginVm.imageCode};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"api/admin/doLogin",success:function(e){console.log("success:",e),200==e.status?window.location.href="/manage":(adminLoginVm.showErr=!0,adminLoginVm.message=e.message,adminLoginVm.reSetImgCode())},error:function(e){console.log("error:",e)}})}}}}),confirmEmailVm=avalon.define({$id:"confirmEmail",email:"",message:"",showErr:!1,validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),confirmEmailVm.showErr=!0,confirmEmailVm.message=e[0].message;else{console.log("全部通过");var s={email:confirmEmailVm.email};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/sentConfirmEmail",success:function(e){console.log("success:",e),200==e.status?(toastr.success(e.message),window.location.href="/"):(confirmEmailVm.showErr=!0,confirmEmailVm.message=e.message)},error:function(e){console.log("error:",e)}})}}}}),loginVm=avalon.define({$id:"userlogin",password:"",email:"",message:"",showErr:!1,reset:function(){loginVm.email=" ",loginVm.password=" "},validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),loginVm.showErr=!0,loginVm.message=e[0].message;else{console.log("全部通过");var s={email:loginVm.email,password:loginVm.password};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/doLogin",success:function(e){console.log("success:",e),200==e.status?window.location.href="/ ":(loginVm.showErr=!0,loginVm.message=e.message)},error:function(e){console.log("error:",e)}})}}}});function getPostMessages(){$.ajax({type:"GET",url:"/api/message/getList?pageSize=100&contentId="+$("#contentId").val(),success:function(e){console.log("success:",e),200==e.status&&(postMsgVm.messageList=e.data.docs)},error:function(e){console.log("error:",e)}})}var postMsgVm=avalon.define({$id:"postMessage",content:"",logined:!1,message:"",showErr:!1,messageList:[],replyState:!1,relationMsgId:"",replyAuthor:"",adminReplyAuthor:"",getAuthor:function(e,s,o){var n=e[s];return n||(e[o]?e[o]:"")},reSetData:function(){postMsgVm.content="",postMsgVm.relationMsgId="",postMsgVm.replyAuthor="",postMsgVm.adminReplyAuthor="",postMsgVm.showErr=!1,postMsgVm.message=""},reply:function(e,s,o){postMsgVm.reSetData(),postMsgVm.replyState=!0,postMsgVm.relationMsgId=e,"0"==o?postMsgVm.replyAuthor=s._id:postMsgVm.adminReplyAuthor=s._id,$("#msgSendBox").appendTo($("#msglist_"+e))},cancelReply:function(){postMsgVm.reSetData(),postMsgVm.replyState=!1,$("#postMessage").prepend($("#msgSendBox"))},validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)postMsgVm.showErr=!0,postMsgVm.message=e[0].message;else if(console.log("全部通过"),"true"==$("#logined").val()){var s=postMsgVm.$model;s.contentId=$("#contentId").val(),delete s.messageList,$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/message/post",success:function(e){console.log("success:",e),200==e.status?($("#postMessage").prepend($("#msgSendBox")),postMsgVm.reSetData(),getPostMessages()):(postMsgVm.showErr=!0,postMsgVm.message=e.message)},error:function(e){console.log("error:",e)}})}else window.location.href="/users/login"}}});function getUserRelevantList(e,s,o){$.ajax({type:"GET",url:"/users/"+e+"?current="+o,success:function(e){console.log("data",e),200==e.status&&("myContents"==s?(myContentsVm.myContentList=e.data.docs,myContentsVm.contentTotalPage=e.data.pageInfo.totalPage):"myMessages"==s?(myContentsVm.myMessageList=e.data.docs,myContentsVm.messageTotalPage=e.data.pageInfo.totalPage):"myJoinTopics"==s&&(myContentsVm.myJoinTopicsList=e.data.docs,myContentsVm.joinTopicsTotalPage=e.data.pageInfo.totalPage))}})}var myContentsVm=avalon.define({$id:"my-contents",myContentList:[],myMessageList:[],myJoinTopicsList:[],contentTotalPage:1,messageTotalPage:1,joinTopicsTotalPage:1,contentPageClick:function(e,s){getUserRelevantList("getUserContents","myContents",s)},messagePageClick:function(e,s){getUserRelevantList("getUserNotifys","myMessages",s)},joinTopicPageClick:function(e,s){getUserRelevantList("getUserReplies","myJoinTopics",s)},deleteNotify:function(e){initCheckModal(myContentsVm,"确认删除该条记录吗？",function(){$.ajax({type:"GET",data:{ids:e},url:"/users/delUserNotify",success:function(e){console.log("data",e),200==e.status?(toastr.success("恭喜，删除成功!"),getUserRelevantList("getUserNotifys","myMessages",1)):toastr.error(e.message)}})})}}),regVm=avalon.define({$id:"reglogin",userName:"",password:"",confirmPassword:"",email:"",message:"",showErr:!1,validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),regVm.showErr=!0,regVm.message=e[0].message;else{console.log("全部通过");var s={userName:regVm.userName,email:regVm.email,password:regVm.password,confirmPassword:regVm.confirmPassword};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/doReg",success:function(e){console.log("success:",e),200==e.status?(toastr.success("{{lk.lc_reg_success_tip}}"),window.location.href="/"):(regVm.showErr=!0,regVm.message=e.message)},error:function(e){console.log("error:",e)}})}}}}),reSetPsdVm=avalon.define({$id:"reSetPsd",password:"",confirmPassword:"",message:"",showErr:!1,validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),reSetPsdVm.showErr=!0,reSetPsdVm.message=e[0].message;else{console.log("全部通过");var s={tokenId:$("#tokenId").val(),confirmPassword:reSetPsdVm.confirmPassword,password:reSetPsdVm.password};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/updateNewPsd",success:function(e){console.log("success:",e),200==e.status?(toastr.success(e.message),window.location.href="/users/login"):(reSetPsdVm.showErr=!0,reSetPsdVm.message=e.message)},error:function(e){console.log("error:",e)}})}}}}),sendEmailInfoVm=avalon.define({$id:"email-user-info",name:"",email:"",comments:"",phoneNum:"",message:"",showErr:!1,validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),sendEmailInfoVm.showErr=!0,sendEmailInfoVm.message=e[0].message;else{console.log("全部通过");var s={email:sendEmailInfoVm.email,name:sendEmailInfoVm.name,phoneNum:sendEmailInfoVm.phoneNum,comments:sendEmailInfoVm.comments};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/postEmailToAdminUser",success:function(e){200==e.status?(toastr.success(e.message),setTimeout(function(){window.location.href="/"},2e3)):toastr.error(e.message)},error:function(e){toastr.error(e)}})}}}}),setPsdVm=avalon.define({$id:"setPsd",password:"",confirmPassword:"",message:"",showErr:!1,validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),setPsdVm.showErr=!0,setPsdVm.message=e[0].message;else{console.log("全部通过");var s={confirmPassword:setPsdVm.confirmPassword,password:setPsdVm.password};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/updateInfo",success:function(e){console.log("success:",e),200==e.status?toastr.success("更新成功!"):(setPsdVm.showErr=!0,setPsdVm.message=e.message)},error:function(e){console.log("error:",e)}})}}}}),userInfoVm=avalon.define({$id:"user-info",userName:"",name:"",email:"",comments:"",phoneNum:"",message:"",showErr:!1,validate:{onError:function(e){e.forEach(function(e){console.log(e.getMessage())})},onValidateAll:function(e){if(e.length)console.log("有表单没有通过",e),userInfoVm.showErr=!0,userInfoVm.message=e[0].message;else{console.log("全部通过");var s={userName:userInfoVm.userName,email:userInfoVm.email,name:userInfoVm.name,phoneNum:userInfoVm.phoneNum,comments:userInfoVm.comments};$.ajax({type:"POST",contentType:"application/json; charset=utf-8",traditional:!0,data:JSON.stringify(s),url:"/users/updateInfo",success:function(e){console.log("success:",e),200==e.status?toastr.success(e.message):toastr.error(e.message)},error:function(e){console.log("error:",e)}})}}}}),userNavVm=avalon.define({$id:"user-nav",currentPath:window.location.pathname});